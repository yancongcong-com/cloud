# 信息安全

### 信息安全的核心目标：CIA模型保护

Confidentiality 机密性

Integrity 完整性

Availability 可用性

### 攻击

D disclosure 泄漏

A Alteration 篡改

D Destruction 破坏

### 信息安全核心技术

安全服务	机密性服务	完整性服务	可用性服务

安全机制	加密机制		访问控制机制	完整性机制

安全技术	对称加密技术	公开加密技术	防火墙技术

### 密码技术

| 单向散列函数   | one-way hash function保证完整性的密码技术                    |
| -------------- | ------------------------------------------------------------ |
| 消息认证码     | message authentication code保证完整性和提供认证的密码技术    |
| 数字签名       | digital signature 保证完整性，提供认证并防止否认的密码技术   |
| 伪随机数生成器 | pseudo random number generator 一种模拟产生随机数列的算法，复制密钥生成 |

### 密码学家的工具箱：这一说法出自《网络信息安全的真相》

信息安全所面临的威胁					受威胁的特性							用来应对的密码技术

窃听													   机密性										 对称密码

​																													公钥密码

篡改														完整性										单向散列函数

伪装														认证											消息认证码

否认														不可否认性								数字签名

对称加密的特点

- 安全
- 紧凑
- 性能高
- 密钥明文共享
- 速度快
- 密钥管理存在瓶颈

非对称算法的特点

- 简化密钥管理
- 算法安全
- 支持数字签名
- 性能低下
- 不紧凑

隐写术和数字水印

隐写术：

数字水印：

### 加密和信息安全常识：

1. 不要使用保密的密码算法：密码算法需要公开，经过破译的验证，才能证明其强度
2. 使用低强度密码比不加密更危险：不要认为有密码安全的错觉
3. 任何密码总有一天会被破解：尝试所有密钥，除非是量子密码或一次性密码本
4. 密码只是信息安全的一部分：社会工程会

### 网络安全威胁的来源：

- 按照网络安全威胁存在的位置来划分：
  1. 来自网络内部的安全威胁
  2. 来自于网络外部的安全威胁
  3. 来自于数据传输过程中的安全威胁
- 从网络层次，业务或应用角度来分析：
  1. 来自于设备物理的安全威胁
  2. 来自于病毒的安全威胁
  3. 来自于安全制度漏洞带来的威胁

### 什么是PKI

Public Key Infrastucture,公钥基础结构

通过公钥技术于数字证书确保信息安全的体系

- 由公钥加密技术，数字证书，CA，RA等共同组成

PKI体系能够实现的功能有：

- 机密性
- 完整性
- 身份验证
- 不可否认性

加密技术简介

明文：需要被隐蔽的信息

密文：明文变换形成的隐蔽形式

加密：把明文转化为密文的过程

解密：把密文转化为明文的过程

密钥：在加密或解密的算法中输入的参数

### 公钥加密技术

非对称加密也叫公钥加密，是PKI的基础

公钥（Public Key）和私有（Private Key）

- 公钥和私钥是成对生成，互不相同，可以互相加解密
- 根据一个密钥无法推算出另一个密钥
- 公钥公开，私钥保密（只有持有人才知道）
- 私钥应该由密钥的持有人妥善保管

数据加密

1. Encryption
2. 发送放使用自己的公钥加密数据
3. 接收放使用自己的私钥解密数据
4. 保证数据的机密性

数字签名

1. Digital Signature
   - 发送方使用私钥对信息摘要进行加密的一个过程
   - 过程中所得到的密文即称为签名信息
2. 发送方将签名信息于原始数据发送给接收方
3. 接收放对原始数据进行摘要计算，得出的值和签名信息进行比对
4. 保证数据的完整性，身份验证和不可否认

摘要信息

- 给予任意大小的数据，得出一个固定长度的值，类似指纹，DNA
- 特点：不可逆，雪崩效应

### 证书

证书用于保证密钥的合法性

证书的主体可以是用户，计算机，服务等

证书格式遵循X.509标准

数字证书包含信息

- 使用者的公钥值
- 使用者标识信息
- 有效期
- 颁发者标识信息
- 颁发者的数字签名

数字证书由权威公正的第三方机构即CA签发

### CA的作用

Certificate Authority,证书颁发机构

CA的核心功能是颁发和管理数字证书

CA的作用

- 处理证书申请
- 发放证书
- 更新证书
- 接受最终用户数字证书的查询，撤销
- 产生和发布证书吊销列表
- 数字证书归档

### PKI协议

SSL（Secure Sockets Layer,安全套接层）

- 认证用户和服务器，确保数据发送到正确的客户机和服务器
- 加密数据以防止数据中途被窃取
- 维护数据的完整性，确保数据在传输过程中不被改变

HTTPS（Hypertext Transfer Protocol Secure）

- 使用SSl来实现安全的通信

IPSec（Internet Protocol Security）

- 目前主流的VPN解决方案

### 对称加密

| 算法              | 密钥         | 开发者                       | 备注               |
| ----------------- | ------------ | ---------------------------- | ------------------ |
| 数据加密标准DES   | 56位         | IBM为美国政府（NBS/NST）开发 | 很多政府强制性使用 |
| 3DES              | 3*56位       | IBM为美国政府（NBS/NST）开发 | 应用3次DES         |
| CAST              | 40-256位可变 | 北方通信                     | 比DES稍快          |
| Rivest算法（RC2） | 可变         | Ron Rivest（RSA数据安全）    | 专利细节位公开     |
| RCS               |              |                              |                    |
| AES               |              | Joan Daemen/Vincent Rjimen   |                    |

### 非对称加密

| 算法 | 设计者         | 用途                 | 安全性       |
| ---- | -------------- | -------------------- | ------------ |
| RSA  | RSA数据安全    | 加密数字签名密钥交换 | 大数分解     |
| DSA  | NSA            | 数字签名             | 离散对数     |
| DH   | Diffie&Hellman | 密钥交换             | 完全向前保密 |

### 安全体系结构

- 安全服务
  1. 认证服务
  2. 访问控制
  3. 数据完整性
  4. 数据保密性 
  5. 抗抵赖
- 安全机制
  1. 加密机制
  2. 访问控制机制
  3. 数据完整性机制
  4. 数字签名机制
  5. 认证交换机制
  6. 业务流填充机制
  7. 路由控制机制
  8. 公证机制
  9. 普适性机制

### TCP/IP协议栈常见安全风险

| 层级       | 攻击                                            |
| ---------- | ----------------------------------------------- |
| 应用层     | 漏洞，缓冲区溢出攻击，WEB应用的攻击，病毒及木马 |
| 传输层     | TCP欺骗，TCP拒绝服务，UDP拒绝服务，端口扫描     |
| 网络层     | IP欺骗，Smuf攻击，ICMP攻击，地址扫描            |
| 数据链路层 | MAC欺骗，MAC泛洪，ARP欺骗                       |
| 物理层     | 设备破环，线路帧听                              |

### 网络攻击分类

网络攻击

- 流量型攻击
  1. 网络层攻击
  2. 应用层攻击
- 单包攻击
  1. 畸形报文攻击
  2. 特殊报文攻击
  3. 扫描窥探攻击

# 防火墙

防火墙：Firewall

- 位于多个信任程度不同的网络之间（如企业内部网络和Internet之间）的设备。
- 对两个网络之间的通信进行控制，通过强制实施统一的安全策略，防止对重要信息资源的非法存取和访问以达到保护系统安全的目的。
- 防火墙 = 硬件 + 软件 + 控制策略
  1. 宽松控制策略：除非明确禁止，否则允许。
  2. 限制控制策略：除非明确允许，否则禁止。

防火墙和路由器实现安全控制的区别

|              | 防火墙                                                    | 路由器                                        |
| ------------ | --------------------------------------------------------- | --------------------------------------------- |
| 背景         | 产生于人们对安全性的需要                                  | 基于对网络数据包由而产生                      |
| 目的         | 保证任何非允许的数据包“不通”                              | 保持网络和数据的“通”                          |
| 核心技术     | 基于状态包过滤的应用级信息流过滤                          | 路由器核心的ACL列表是基于简单的包过滤         |
| 安全策略     | 默认配置即可以防止一些攻击                                | 默认配置对安全性的考虑不够周全                |
| 对性能的影响 | 采用的是状态包过滤，规则条数。NAT的规则数对性能的影响较小 | 进行包过滤会对路由器的CPU和内存产生很大的影响 |
| 防攻击能力   | 具有应用层防范功能                                        | 普通路由器不具有应用层的防范功能              |

### 防火墙发展

包过滤-----1989

应用代理

状态检测------1994

UTM------2004

下一代防火墙---2009

传统防火墙面临的问题：

- 协议识别技术，仅检查报文的五元组，根据TCP/UDP报文的端口号来识别应用，而目前有许多传统和新兴应用采用了各种端口隐秘技术来逃避检测，如使用非知名端口和随机端口
- 另一方面，一个协议可以用于多个应用程序，一个应用程序可以使用多个协议

包过滤防火墙：在网络层对每一个数据包进行检查，根据配置的规则转发或丢包数据，通过配置ACL实现

1. 无法关联数据包之间的关系
2. 无法适应多通道协议
3. 通常不检查应用层数据

应用代理防火墙：作用于应用层，其实质是把内部网络和外部网络用户之间直接进行的业务由代理接管

1. 处理速度慢
2. 升级困难

状态检测防火墙：包过滤技术的扩展，基于连接状态的包过滤在进行数据包的检查时，不仅将每个数据包看成是独立单元，还要考虑前后报文的历史关联性

1. 处理后续包速度快
2. 安全性高

### 部署场景 

防火墙工作模式

| 模式     | 特点               |
| -------- | ------------------ |
| 路由模式 | 每个接口均有IP地址 |
| 透明模式 | 每个接口均有IP地址 |
| 混合模式 | 部分接口有IP地址   |

隔离：防火墙和交换机对比

| 防火墙                                                   |                      |            | 交换机                                                       |
| -------------------------------------------------------- | -------------------- | ---------- | ------------------------------------------------------------ |
| 无交换板时的工作模式在IP层路由数据                       | 路由模式             | 纯三层交换 | 等同于传统路由器，交换机很少工作在纯三层模式                 |
| 交换板上的接口只工作在二层，可做三层路由接口在仅三层路由 | 混合模式（缺省模式） | 三层交换   | 同时做二三层交换机，在二层，做VLAN内的数据交换，在三层，做VLAN内的数据交换 |
| 所有路由接口工作在交换模式。仅在在VLAN内交换数据         | 透明模式             | 二层交换   | 仅在各自的VLAN内做数据交换，不在VLAN之间交换数据             |

### 区域

Zone：划地而治，等级森严，在防火墙上引入的一个重要的逻辑概念。

- 是一个或多个接口的集合
  - 一个接口所连网络只能属于一个区域中的
  - 一个区域可以包含多个接口所连的网络
- 通过区域来划分网络，标识报文流动的“路线”，当报文在不同的区域之间流动时，才会触发安全检查。
- 每个区域具有全局唯一的安全优先级
- 默认情况下：
  - 报文在不同的安全区域之间流动时，才会触发安全检查
  - 报文在同一个安全区域中流动时，才会触发安全检查
  - 同时，华为的防火墙也支持对同一个安全区域内经过防火墙的流量进行安全检查，更加灵活适用
- 大部分的安全策略都是基于安全区域实施

区域：防火墙和交换机区别

| 交换机                 | 场景       | 场景               | 防火墙                                                       |
| ---------------------- | ---------- | ------------------ | ------------------------------------------------------------ |
| 基于用户属性划分VLAN   | 用户接入   | 保护一个子网       | a)划分内网与外网区域<br />b)防火墙部署子网边界               |
| 基于服务器属性划分VLAN | 服务器汇聚 | 保护多个子网       | a)为每一个区域划分一个安全区域<br />b)防火墙部署于INternet出口处<br />c)为每个域间访问定制俺去那策略 |
| 基于交换机属性划分VLAN | 交换机汇聚 | 多业务或多用户隔离 | 为每个业务或者用户分配一个虚拟防火墙                         |

默认区域：防火墙内置，无法修改安全级别，无法删除

| 名称                | 安全级别                                                  | 场景                                   |
| ------------------- | --------------------------------------------------------- | -------------------------------------- |
| 虚拟区（VZone）     | 最低级别，安全级别为0                                     | 虚拟防火墙                             |
| 非信任区（Untrust） | 低级级别，安全级别为5                                     | 外部网络                               |
| 非军事化区（DMZ）   | 中度级别，安全级别为50                                    | 公共服务器                             |
| 受信区（Trust）     | 较高级别，安全级别为85                                    | 内部网络                               |
| 本地区域（Local）   | 最高级别，安全级别为100                                   | 防火墙本身                             |
| PS                  | Local区域中不能添加任何接口，但防火墙上所有接口本身隐含属 | 于Local区域。USG防火墙最多支持32个区域 |

区域方向：

| 入方向（inbound）  | 数据由低到高安全级别的区域传输的方向 |
| ------------------ | ------------------------------------ |
| 出方向（Outbound） | 数据由高到低安全级别的区域传输的方向 |

### 状态检测和会话机制

- 状态检测防火墙适用基于连接状态的检测机制，将通信双方之间交互的属于同一连接的所有报文都作为整体的数据来对待，同一个数据流内的报文不再时孤立的个体，而是存在联系的。
- 为首包建立会话，后续报文直接根据会话进行转发，提高了转发效率。
- 源地址，源端口，目的端口，目的地址和协议这五个元素称为“五元组”。只要“五元组”相同的报文即可认为属于同一条数据流，在防火墙上就可以唯一确定一条连接
- 防火墙会在一段时间后删除火花，该时间称为会话的老化时间。

策略：防火墙和交换机区别

|        | 命令形式 | 匹配机制                   | 缺省过滤策略 |
| ------ | -------- | -------------------------- | ------------ |
| 交换机 | ACL      | 逐包匹配                   | 转发         |
| 防火墙 | policy   | 首包匹配，后续包匹配会话表 | 禁止         |

- 首包的定义
  1. TCP的首包：SYN置位的报文
  2. ICMP的首包：Echo Request报文
  3. UDP的首包：查不到会话时即认为时首包

|      | 定义                                                   | 特性                                                         | 抓发                                                         |
| ---- | ------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 包   | 封装在一起的一组数据，由完整的网络层头部               | a)不考虑包的前因后果关系<br />b)通常只处理到网络层报文头信息 | 转发时不考虑当前于前后包的关系，依据包头中的DIP信息转发      |
| 流   | 通常一个完整的流由多个包组成，含有一次通信中的所有数据 | a）有头有尾，有始有终<br />b) 需要处理到网络层和传输层的报文头信息 | 转发时需记录包所属的流，依据5组信息识别一个流，并识别当前包和前后包的关系，系统会记录于这个流相关的协议状态 |

| 三层交换机路由器 | 基于报文目的地址逐包转发，不考虑协议状态    | 逐包转发           |
| ---------------- | ------------------------------------------- | ------------------ |
| 防火墙           | 基于报文5元组的流转发，根据协议状态处理报文 | 状态检测，逐流转发 |

早期的防火墙也是逐包转发的，逐包转发的防火墙其安全性很低

### 安全策略

简介：防火墙要实现“网络隔离”，“访问控制”，“安全检查”等技术，那就必须配置一个“安检员”，江湖人称“安全策略”。

安全策略原理：根据定义的规则对经过防火墙的流量进行筛选，并根据关键字确定刷选出的流量如何进行下一步操作，可以基于IP，端口，协议等属性进行细化的控制。

默认策略：

- 域间的所有方向都禁止报文通过
- 域内数据流动不受限制
- 路由，ARP等底层协议一般是不受安全策略控制的，直接允许通过

安全策略的应用方向：

- 对于同一条数据流，在访问发起的方向上应用安全策略即可，方向报文不需要额外的策略。

安全策略的匹配：

- 策略的优先级按照配置顺序进行排列，越先配置，优先级越高，越先匹配。
- 如果报文匹配到一条策略就不再继续匹配剩下的策略
- 如果没有匹配到任何策略就按照缺省包过滤处理
- 所以配置策略还是有一定讲究的，要先细后粗。

防火墙基本流程

开始---以太网接口模式-----接口IP地址----接口加入域----配置网络--配置对象---配置策略---数据包转发

### 防火墙配置

- 管理员配置

  ```shell
  aaa
  manager-user wakin
  service-type api|ftp|ssh|telnet|web
  password cipher huawei.com
  level 15
  ```

- 区域配置

  ```shell
  firewall zone name PC
  set priority 80
  add interface GigabitEthernet 1/0/0
  display zone
  ```

- 策略配置

  ```shell
  security-policy
  default action permit|deny
  rule name policy_sec
  source-zone PC
  destination-zone Server
  action permit|deny
  display firewall session table
  reset firewall session table
  display firewall session aging-time
  ```


### 状态检测

FTP连接类型

控制连接

- 用于控制命令及命令执行信息
- 在会话期间一直保持打开

数据连接

- 用于数据传输，包括数据上传下载，文件列表发送等
- 在数据传输结束后将终止

ASPF

技术背景：多通道协议

- 这种协议会在通信过程中自动协商一些随机端口，在严格按照安全策略的情况下，这些随机端口发出的报文可能得不到正常转发

FTP运行模式

- 主动模式（Active Mode）

  1. 称为POST模式

  2. FTP客户端通过向FTP服务器发送POST命令，告诉服务器该客户端用于传输数据的临时端口号。
  3. 当需要传送数据时，服务器通过TCP端口号20与客户端的临时端口号建立数据传输通道，完成数据传输。

- 被动模式（Passive Mode）

  1. 也称为PASV模式
  2. FTP客户端通过向FTP服务器发送PASV命令，告诉服务器进入被动模式，服务器选择临时端口号并告知客户端
  3. 当需要传送数据时，客户端主动与服务器的临时端口号建立数据传输通道。完成数据传输。

ASPF：Application Speciffic Packet Filter,针对应用层的包过滤（隐形的翅膀）

- 为了解决多通道协议的转发而引入
- 为这种协议的应用层进行解析，识别这些协议协商出来的端口号，从而自动为其开放相应的访问规则，解决这些协议不能正常转发的问题
- 并且动态生成Server-map表项（ASPF的基础），简化了安全策略的配置又确保了安全性
- 可以把ASPF看作是一种穿越FW的技术，ASPF生成的Server-map表项，相当于在FW上打开了一个通道，使多通道协议的后续报文不受安全策略的控制，利用该通道就可以穿越FW。

Server-map：该表项主要是用于存放一种映射关系，设备根据这种隐射关系对报文的地址进行转换，并转发，不再受安全策略的控制。

Server Map的产生

- 转发多通道协议
- NAT Server 或SLB时
- NAT NO-PAT
- 转发QQ/MSN

### NAT

NAT的分类

- 源NAT
  1. 根据转换的方向：Inbound NAT和Outbound NAT
  2. 根据端口是否转换：No-PAT和NAPT
- 目的NAT
  1. 分为NAT Server和目的NAT 
- 双向NAT 
  1. Nat Inbound 和 NAT  Server一起使用
  2. 域内NAT和NAT Server 一起使用

Server-map表项主要是用于存放一种映射关系，设备根据这种映射关系对报文的地址进行转换，并转发。

NAT生成Server-map的两种情况

- 配置NAT Server成功后生成静态表项
  1. 用于存放Global地址和Inside地址映射关系
  2. 不配置“no-reverse”参数时，生成正方向两个server-map
  3. 配置“no-reverse”参数时，只生成正 方向server-map
- 配置NAT No-PAT后，流量触发建立Server-map表
  1. 用于存放私网ip地址和公网ip地址的映射关系。

NAT地址池

```
nat address-group 1 起 始
```



nat的优点与缺点

- 优点：
  1. 实现IP地址复用，节约宝贵的地址资源
  2. 地址转换过程对用户透明
  3. 对内网用户提供隐私保护
  4. 可实现对内部服务器的负载均衡
- 缺点：
  1. 网络监控难度加大
  2. 限制某些具体应用

NAT地址池：是一个虚拟的概念，它形象地把“公网IP地址的集合”比喻成一个“放IP地址的池子或容器”，防火墙在应用源NAT功能时就是从地址池中的挑选出一个公网IP，然后对私网IP进行转换（挑选哪个公网IP时随机的，和配置顺序，IP大小等因素都没有关系）

NAT分类：

| 源NAT类型 | 私网对应公网 | 是否端口转换 |
| ----- | -------- | -------- |
| NAT NO-PAT | 一对一 | 否 |
| NPAT | 多对一<br />多对多 |是|
| 出接口地址方式<br />（Easy-IP） | 多对一 | 是 |
| Smart NAT<br />(仅高端防火墙USG9000系列支持) | 一对一<br />（预留IP做多对一转换） | 否<br />（预留IP做端口转换） |
| 三元组NAT<br />（仅高端防火墙USG9000系列支持） | 多对一<br />多对多 | 是 |

NAT ALG：Application Level Gateway,应用级网关

- 可以对报文的载荷字段进行解析，设别并转换其中包含的重要信息，保证类似FTP的多通道协议可以顺利的进行地址转换而不影响其正常使用。

NAT ALG与ASPF的关系：

- 共同点：二者使用相同的配置，开启其中一个功能，另一个功能同时生效。
- 差一点：
  1. 开启ASPF功能的目的是识别多通道协议，并自动为其开放相应的安全策略。
  2. 开启NAT ALG功能的目的也是识别多通道协议，并自动转换报文荷载中的IP地址和端口信息

### VPN

VPN：Virtual Private Network,虚拟专用网络

| VPN  | 通过公共网络建立私有网络，并提供一定的安全性和服务质量保证。IEIF草案对基于IP的VPN的定义是：使用IP机制仿真出一个私有的广域网 |
| ---- | ------------------------------------------------------------ |
| 虚拟 | 用户不在需要拥有实际的专用长途数据线路，而是利用Internet的长途数据线路建立自己的私有网络 |
| 专用 | 用户可以为自己制定一个最符合自己                             |

VPN核心技术：

隧道技术：隧道两端封装，解封装，用以建立数据通道

密钥管理技术：保证接入VPN的操作人员的合法性，有效性

身份认证：数据在网络传输过程中不被非法篡改

加解密技术：保证数据在网络中传输时不被非法获取

数据认证：在不安全的网络中安全地传递密钥

VPN优点：

1. 节约成本
2. 提高安全性
3. 扩展性强
4. 在公网上为两个局域网开辟一条安全的数据传输隧道

VPN类型（根据建设单位划分）：

- 租用运营商专线搭建VPN网络：MPLS VPN
- 用户自建企业VPN网络：GRE,PPTP,L2TP,IPSec,SSL VPN

VPN类型（根据组网方式划分）：

- Remote-Access VPN远程访问VPN
  1. 适合出差员工，移动办公等VPN拨号接入的场景。员工可以在任何能够接入公网的地方，通过远程拨号接入企业内网，从而访问内网资源。通常拨号方IP地址不固定
- Site-to-Site VPN站点到站点VPN
  1. 适合各分支机构，合作伙伴，客户，供应商间的互联。双方都有固定的IP地址。

VPN类型（根据实现层，协议划分）：

L7 ：SSL 

L3：GRE IPSec

L2：PPTP L2F L2TP

VPN类型（根据应用场景划分）：

| Remote Access VPN                  | 面向出差员工，移动办公。                            |
| ---------------------------------- | --------------------------------------------------- |
| Intranet VPN企业内部虚拟专网       | 进行企业内部各个分支机构网络的互连                  |
| Extranet VPN扩展的企业内部虚拟专网 | 将企业网延申至合作伙伴处，是不同企业通过公网建筑VPN |
| Intranet VPN和Extranet VPN区别     | 访问公司总部网络资源的权限有区别                    |

|          | GRE                                | L2TP                              | IPSec                                                        | SSL VPN                                                    |
| -------- | ---------------------------------- | --------------------------------- | ------------------------------------------------------------ | ---------------------------------------------------------- |
| 保护范围 | IP层及以上数据                     | IP层以及上数据                    | IP层以及上数据                                               | 应用层特定数据                                             |
| 适合场景 | Intranet VPN                       | Access VPN,Extranet VPN           | Intranet VPN,Access VPN                                      | Access VPN                                                 |
| 身份认证 | 不支持                             | 支持，基于PPP的Chap，PAP，EAP认证 | 支持，采用IP或ID+口令或证书进行数据源认证；IKEv2拨号方式采用EAP认证进行用户身份认证 | 支持，用户名+口令+证书对服务器进行认证。也可以进行双向认证 |
| 加密技术 | 不支持                             | 不支持                            | 支持                                                         | 支持                                                       |
| 数据验证 | 支持（校验和方式验证，关键字验证） | 不支持                            | 支持                                                         | 支持                                                       |
| 如何使用 | GRE over IPSec                     | L2TP over IPSec                   | 单独使用IPSec,或通过IPSec保护GRE,L2TP                        | SSL VPN                                                    |

L2TP端口号：UDP 1701

PPTP端口号：TCP 1723

### GRE VPN

通过路由封装协议GRE（Generic Routing Encapsulation）提供了将一种协议的报文封装在另一种协议报文中的机制，是一种隧道封装技术。GRE可以封装组播数据，并可以和IPSec结合使用，从而保证语音，视频等组播业务的安全

GRE概述：Generic Routing Encapsulation,通用路由封装

- 一种三层VPN封装技术
- 在任意一种网络协议上传送任意一种其他网络协议的封装方法
- 解决了跨越异种网络的报文传输问题。异种报文传输的通道称为Tunnel（隧道）

| GRE优点            | GRE缺点                    |
| ------------------ | -------------------------- |
| 建立隧道           | 点对点隧道                 |
| 支持多种网络层协议 | 静态配置隧道参数           |
| 支持路由组播       | 部署复杂连接关系时代价巨大 |
| 配置简单，容易部署 | 缺乏安全性                 |

GRE核心功能：建立隧道，打通私网

GRE VPN路由宣告注意事项：使用动态路由协议宣告接口时千万不能宣告公网接口

GRE VPN隧道虚假状态问题：只要有到达隧道目标的路由，隧道口即可激活

解决方法：开启GRE的Keeplive

Keepalive检测功能用于检测隧道对端是否可达。

keepalive period 3

GRE安全策略：从原始报文进入GRE隧道开始，到GRE报文被FW转出，这个过程报文跨越了两个域间关系。由此可以将GRE报文所经过的安全区域看成两个部分，一个原始报文进入GRE隧道前所经过的安全域，一个报文经过GRE封装后经过的安全域。

### IPSec VPN

简介：企业对网络安全性的需求日益提升，而传统的TCP/IP协议缺乏有效的安全认证和保密机制。IPSec(Internet Protocol Security)作为一种开放标准的安全框架结构。可以用来保证IP数据报文的网络上传输的机密性，完整性和防重放。

IPSec：Internet Protocol Security

- 源于IPV6
- IETF制定的一套安全保密性能框架
- 建立在网络层的安全保障机制
- 引入多种加密算法，验证算法和密钥管理机制
- 也具有配置复杂，消耗运算资源较多，增加延迟，不支持组播等缺点
- IPSec VPN是利用IPSec隧道建立的VPN技术

IPSec核心功能：

| 机密性   | 对数据进行加密，确保数据在传输过程中不被其他人员查看         |
| -------- | ------------------------------------------------------------ |
| 完整性   | 对接收到数据包进行完整性验证，以确保数据在传输过程中没有被篡改 |
| 真实性   | 验证数据源，以保证数据来自真实的发送则（IP包头内的源地址）   |
| 抗重放性 | 防止恶意用户通过重复发送捕获到的数据包所进行的攻击，即接收方会拒绝旧的或重复的数据包 |

IPSec技术框架

IPSec架构

- IPSec不是一个单独的协议，它通过AH和ESP这两个安全协议来实现IP数据报的安全传送。
- IKE协议提供密钥协商，建立和维护安全联盟SA等服务。


安全协议：	ESP 								AH

加密：DES 3DES AES SM1/SM4

验证： MD5 SHA1

密钥交换技术 IKE(ISAKMP,DH)

md2和sha-1验证算法存在安全隐患，建议优先使用SHA-2或SM3算法

DES和3DES加密算法存在安全隐患，建议优先使用AES,SM1或SM4算法

IPSec核心协议：

AH：AH（Authentication Header）报文头验证协议，主要提供完整性，真实性，防重放功能；然而，AH并不加密数据报文（机密性）。IP协议号=51

ESP：ESP（Encapsulating Security Payload）封装安全载荷协议。除提供AH协议的所有功能外（但其完整性校验不包括IP头），还可提供对数据报文的加密功能。IP协议=50.

IPSec封装模式：

传输模式：在传输模式（Transport Mode）下，IPSec头被插入到IP头之后但在所有传输层协议之前，或所有其他IPSec协议之前。

隧道模式：在隧道模式（Tunnel Mode）下，IPSec头插在原始IP头之前，另外生成一个新的报文头放到AH或ESP之前。

封装模式对比：

- 安全性：
  1. 隧道模式因此ip信息，安全性更好。
- 性能：
  1. 隧道模式有一个额外的IP头，隧道模式比传输模式占用更多带宽。

传输模式：传输点=加密点

隧道模式：传输点！=加密点

IPSec工作流程中的专业术语：

| Negotiate | 协商，两个节点要开始安全发送数据之前，必须完成的事情。       |
| --------- | ------------------------------------------------------------ |
| SA        | Security Association 安全联盟，协商的结果，类似合约书        |
| SPI       | Security Parameter Index,安全参数索引，SA内包含，用于区分多个SA。 |
| IKE       | Internet Key Exchange，因特网密钥交换，SA协商的方法和标准。  |

安全联盟SA

Local address

remote Address

Spi inbound

spi outbound

key

Transform(Proposal)

- 安全联盟定义了IPSec对等体间将使用的数据封装模式，认证和加密算法，密钥等参数
- 安全联盟是单向的，两个对等体之间的双向通信，至少需要两个SA

安全联盟建立方式：手工方式和IKE自动协商方式。二者的主要区别为：

- 密钥生成方式不同
  1. 手工方式下，建立SA所需的全部参数，包括加密，验证密钥，都需要用户手工配置，也只能手工刷新，在中大型网络中，这种方式的密钥管理成本很高。
  2. IKE方式下，建立SA需要的加密，验证密钥是通过DH算法生成的，可以动态刷新，因而密钥管理成本低，且安全性较高。
- 生存周期不同
  1. 手工方式建立的SA，一经建立永久存在；
  2. IKE方式建立的SA，其生存周期由双方配置的生存周期参数控制。
- 因此，手工方式适用于对等体设备数量较少时，或是在小型网络中。对于中大型网络，推荐使用IKE自动协商建立SA。

| 阶段             | 备注                                                         |
| ---------------- | ------------------------------------------------------------ |
| 阶段1（Phase 1） | 在网络上建立一个IKE SA，为阶段2协商提供保护分主模式（Main Mode）和野蛮模式（Aggerssive Mode） |
| 阶段2（Phase 2） | 在阶段1建立的IKE SA的保护下完成IPSec SA的协商快速模式（Quick Mode） |

IPSec VPN配置

配置网络可达

配置ACL识别感兴趣流

创建安全提议

创建安全策略

应用安全策略

--------------------------------------------------------------

安全提议

| 命令                                  | 备注                      |
| ------------------------------------- | ------------------------- |
| ipsec proposal shanghai               | 创建并配置IPSec提议       |
| encapsulation-mode tunnel             | 配置报文的封装模式        |
| transform esp                         | 配置隧道采用的安全协议    |
| esp authentication-algorithm sha2-256 | 配置ESP协议使用的认证算法 |
| esp encryption-algorithm aes-128      | 配置esp加密算法           |
| display ipsec proposal                | 验证IPSec提议配置         |
|                                       |                           |

安全策略

-----------------------------------------------------------------------------------------------------------------------------------------------------------

手动

| 命令                                            | 备注                                                         |
| ----------------------------------------------- | ------------------------------------------------------------ |
| ipsec policy p1 10 manual                       | 创建并配置IPSec策略（手动）                                  |
| security acl 3000                               | 配置引用的ACL                                                |
| proposal shanghai                               | 配置引用的提议                                               |
| tunnel local 12.0.0.2                           | 配置安全隧道的本端地址                                       |
| tunnel remote 13.0.0.3                          | 配置安全隧道的对端地址                                       |
| sa spi inbound/outbound esp 12345               | 配置SA的SPI.入方向和出方向都必须设置，并且双方的必须相互对应 |
| sa string-key inbound/outbound esp cipher wakin | 配置SA的认证密钥。入方向和出方向都必须设置，并且双方的必须相互对应 |
| display ipsec policy                            | 验证IPSec 手动策略配置                                       |

------------------------------------------

ike提议（自动）

| 命令                                   | 备注              |
| -------------------------------------- | ----------------- |
| ike proposal 10                        | 创建并配置IKE提议 |
| authentication-method pre-share        | 配置身份认证方式  |
| authenticentication-algorithm sha2-256 | 配置数据认证算法  |
| encryption-algorithm aes-cbc-256       | 配置加密算法      |
| dh group 14                            | 配置密钥交换算法  |
| display ike proposal                   | 验证IKE提议       |

IKE对等体

| 命令                          | 备注                |
| ----------------------------- | ------------------- |
| ike peer shanghai v1          | 创建并配置IKE对等体 |
| exchange-mode main/aggressive | 配置模式            |
| pre-shared-key cipher huawei  | 配置PSK             |
| ike-proposal 10               | 配置引用的IKE提议   |
| local-address 12.0.0.1        | 配置本地IP地址      |
| remote-address 23.0.0.3       | 配置对端IP地址      |

自动安全策略

| 命令                      | 备注                        |
| ------------------------- | --------------------------- |
| ipsec policy p2 10 isakmp | 创建并配置IPSec策略（自动） |
| security acl 3000         | 配置引用的ACL               |
| proposal 10               | 配置引用的IPsec提议         |
| ike-peer shanghai         | 配置引用的IKE对等体         |

### L2TP

L2TP：Layer 2 Tunneling Protocol。二层隧道协议，是VPDN隧道协议的一种。

VPDN：Virtual Private Dial-up Network，虚拟私有拨号网

- 是指利用公共网络的拨号功能接入公共网络，实现虚拟专用网，从而为企业，小型ISP,移动办公人员等提供接入服务。

VPDN隧道主要包括以下三种：

- PPTP（Point-to-Point Tunneling Protocol,点到点隧道协议）
- L2F（Layer 2 Forwarding,二层转发）
- L2TP
- 目前使用最广泛的是L2TP

L2TP的角色：

- L2TP在PPP协议基础进行扩展，使用可以安全访问企业内网。
- L2TP提供了对PPP链路层数据帧的隧道传输帧的隧道传输支持，允许二层链路端口和PPP会话点驻留在不同设备上，扩展了PPP模型。
- L2TP中，用户通过PPP拨号到LAC上，LAC通过L2TP隧道将PPP报文透明传输到LNS，LNS随即与用户建立PPP连接。即PPP二层链路端口点LAC，而PPP的会话终止点为LNS，而对于用户来说，感知不到是否使用了L2TP封装技术，可以说，L2TP建立了一条跨LAC的用户与LNS之间的PPP链路。
- L2TP中，LAC和LNS分别对用户进行认证，从而大大提高了用户接入的安全性。

| LAC  | L2TP Access Concentrator,L2TP访问集中器，具有PPP端系统和L2TP协议处理能力的设备，主要用于为PPP类型的提供接入服务 |
| ---- | ------------------------------------------------------------ |
| LNS  | L2TP Network Server,L2TP网络服务器，即是PPP端系统，又是L2TP协议的服务器端，通常作为一个企业内部网的边缘设备。 |

L2TP应用场景：L2TP隧道模式

| NAS-Intiated     | 由LAC（指定NAS）发起L2TP隧道连接。用户通过PPPoE拨入LAC，由LAC向LNS发起建立隧道连接请求。用户的私网地址由LNS分配；用户的验证与计费既可由LAC侧代理完成，也可在LNS侧完成。适用于分支机构用户向总部发起连接，且一般用于分支机构的用户不经常访问企业总部的情况。 |
| ---------------- | ------------------------------------------------------------ |
| Client-Initiated | 由用户直接（支持L2TP协议的PC或移动终端）向LNS发起L2TP隧道连接请求，无需经过一个单独的LAC设备建立隧道。用户的私网地址由LNS分配。适用于出差员工使用PC，手机等移动设备接入总部服务器，实现移动办公，不受地域限制。 |

隧道和会话的关系：

- NAS-Initiated VPN隧道和会话的关系：多个拨号一个隧道
- Client-Initiated VPN隧道和会话的关系：一个拨号一个隧道

认证方式：L2TP支持使用PAP和CHAP两种方式进行PPP认证

L2TP over IPSec：IPSec应用中一种常见的扩展方式，它可以综合两种VPN的优势，通过L2TP实现用户验证和地址分配，并利用IPSec保障安全性。

# 高可靠性

- 在当前的组网应用中，用户对网络可靠性的要求越来越高，特别是在一些重要的业务入口或接入点上需要保证网络不间断运行。对于这些重要的业务点如何保证网络的不间断传输，成为必须解决的一个问题

### HA

HA：High Availability，指一个产品或系统具有很高的可靠性。

- 不能频频出现故障
- 出现故障后能很快恢复

可靠性

- 可靠性：Availability

  可靠性：MTBF/(MTBF+MTTR)

- MTBF：Mean Time Between Failure

  平均无故障时间，衡量稳定程度

- MTTR：Mean Time to Repair

  故障平均修改时间，衡量故障响应修复速度

高可靠性在园区的应用

- 网络高可靠性主要是指当设备或网络出现故障时，网络提供服务的不间断性。
  1. 可靠性达到5个9以上
  2. 可靠性99.999%意味着每年故障时间不超过5分钟
  3. 可靠性99.9999%意味着每年故障时间不超过30秒
- 园区网可靠性技术
  1. 链路备份技术
  2. 设置备份技术
  3. 堆叠技术

链路备份技术

- 链路备份技术用于避免由于单链路故障导致的网络通信终端。当主链路中断后，备用链路会成为新的主用链路。
  1. 链路聚合
  2. RRPP
  3. Smart Link

链路聚合

- 链路聚合时把多条物理链路聚合在一起，形成一条逻辑链路。
- 采用链路聚合可以提供链路冗余性，又可以提高链路的带宽。

RRPP

- RRPP（Rapid Ring Protection Protocol,快速环网保护协议）是一个专门应用于以太网环的链路层协议。
- 在以太网环上一条链路断开时，RRPP能迅速恢复网上各个节点之间的通信道路，具备较高的收敛速度。

Smart Link

- Smart Link解决方案，实现了主备链路的冗余备份，
- 具备

设备备份技术

- 设备备份技术用于避免由于但设备故障导致的网络通信中断。当主设备中断后，备用板卡或备用设备会成为新的主设备。
  1. 设备自身的备份技术
  2. 设备间的备份技术VRRP

设备自身的设备技术

- 主备备份指用主控板作为主用主控板的一个完全印象，出来不处理业务，不控制系统外，其他与主用控板保持完全同步。
- 当主用板发生故障或者被拔出时，备用板将迅速自动取代主用板成为新的主用板，以保证设备的继续运行
- 主备备份应用于分布式网路产品的主控板，提高网络设备的可靠性

堆叠

- 将多台设备通过堆叠口连接起来，形成一台虚拟的逻辑设备。其优点包括：
  1. 简化管理
  2. 提高性能
  3. 弹性扩展
  4. 高可靠性

三大集群技术：思科的VSS，华为的CSS，华三的IRF。

### VRRP

通常，一个网段内只有一个网关。因此一旦网关出现故障，该网段就被孤立了。

VRRP：Virtual Router Redundancy Protocol,虚拟路由器冗余协议

- 将多个物理网关加入到备份组中，形成一台虚拟网关，承担物理网关功能。
- 只要备份组中仍有一台物理网关正常工作，虚拟网关就仍然正常工作。
- 两个版本：VRRPv2基于IPv4,VRRPv3基于IPv6.

VRRP备份组：VRRP Group

- 将局域网内的一组网关设备划分在一起，称为一个备份组。
- 由一个主和多个备组成，功能上相当于一台虚拟网关。
- 虚拟网关具有一个虚拟IP地址，作为终端的网关IP地址。

VRRP选举规则：根据优先级，选举出Master,承担网关功能。

| Master   | 负责应答对虚拟IP地址的ARP请求，转发发往虚拟网关的数据包      |
| -------- | ------------------------------------------------------------ |
| Backup   | 负载在Master故障后，接替Master的工作                         |
| 优先级   | 0~255，默认100，越大越优先。255：保留给IP地址拥有者使用。0：用于触发Backup立即成为Master.如果优先级一致，IP地址越大越优先。 |
| 抢占规则 | 默认开启抢占                                                 |

VRRP定时器：

| 通告间隔定时器 | 默认1秒<br />Master会定时发送VRRP通告报文，通知自己工作正常。如果Backup在等待了3个间隔时间后，依然没有收到通告报文，则认为自己时Master，并对外发送VRRP通告报文，重新进行Master的选举。 |
| -------------- | ------------------------------------------------------------ |
| 抢占延迟定时器 | 默认0秒<br />为了避免频繁进行主备转换，让Backup有足够的时间搜集必要的信息（如路由信息）。<br />Backup接收到优先级较低的VRRP通告报文后，不会立即抢占成为Master，而是等待一定时间后，才会对外发送VRRP通告报文取代原来的Master。 |

VRRP状态机制：
接口shutdown: 进入Initialize

ip地址拥有者-->master

非ip地址拥有者-->Backup

master 收到VRRP协议报文，且报文携带的PRI大于本地PRI，接口地址大于本地接口ip----------->Backup

Backup Master down（3个间隔时间+VRRP抢占延迟时间），或者收到VRRP协议报文，且报文携带的PRI小于本地PRi,且抢占模式为TRUE

VRRP设计方案注意事项：Master应该和STP的根桥保持一致，否则导致次优路径。

VRRP跟踪：当Master上行链路故障时，自动修改优先级，重新选举Master.(默认减十)

VRRP配置：

| 命令                                             | 描述                   |
| ------------------------------------------------ | ---------------------- |
| vrrp vrid 1 virtual-ip 192.168.1.254             | 创建备份组及虚拟IP地址 |
| vrrp vrid 1 priority 200                         | 配置优先级             |
| vrrp vrid 1 timer advertise 1                    | 配置通告延迟           |
| vrrp vrid 1 preempt-mode disable                 | 关闭抢占模式           |
| vrrp vrid 1 preempt-mode timer delay 3           | 配置抢占延迟           |
| vrrp vrid 1 authentication-mode simple/md5 wakin | 配置认证               |
| vrrp vrid 1 track interface vlanif 2             | 配置接口跟踪           |
| display vrrp brief/interface                     | 验证VRRP               |

### 双机热备

防火墙双机部署挑战：

- 传统的网络设备（如路由器，三层交换机），只需要在两台设备上做好路由的备份就可以保证业务的可靠性。
- 但防火墙是状态检测设备，基于会话匹配来完成报文转发，所以当防火墙双机部署时还需要考虑两个防火墙之间的会话等状态信息的备份。

防火墙双机热备部署方案：提供一条专门的备份通道，用于两台防火墙之间协商主备状态，以及会话等状态信息和配置命令的备份，主要有两种方式：

| 主备备份 | 正常情况下不仅由主用设备处理业务，备用设备空闲；当主用设备接口，链路或整机故障时，备用设备切换为主用设备，接替主用设备处理业务 |
| -------- | ------------------------------------------------------------ |
| 负载分担 | 也可以称为“互为主备”，即两台设备同时处理业务。当其中一台设备发生故障时，另外一台设备会立即承担其业务，保证原来需要通过这台设备转发的业务不中断。 |

热备协议：三大协议协同工作实现防火墙双机热备功能

| VRRP | 实现设备冗余，保持网络通信的连续性和可靠性                 |
| ---- | ---------------------------------------------------------- |
| VGMP | 实现对VRRP备份组的统一管理，保证多个VRRP备份组状态的一致性 |
| HRP  | 实现防火墙双机之间动态状态数据和关键配置命令的备份         |

VGMP：VRRP Group Management Protocol,VRRP组管理协议

- 将多个 VRRP备份组都加入到一个VRRP管理组，统一控制各VRRP备份组状态的切换，来保证管理组内的所有VRRP备份组状态都是一致的。
- 最终保证报文来回路劲通过同一台防火墙。

VGMP状态：Master/Slave，类似VRRP

VGMP HELLO：默认间隔1s，保活3s

VRRP备份组加入到VGMP管理组后，状态不能自行单独切换，原来的抢占功能将失效，抢占行为发生与否必须由VGMP管理组统一决定。

HRP：Huawei Redundancy Protocol，华为热备协议

- 承载在VGMP报文上进行传输
- 负载将主防火墙关键配置和会话表状态等数据向备防火墙同步

心跳口与心跳链路探测报文：

- 两台防火墙之间备份的数据是通过心跳口发送和接收的，通过心跳链路（备份通道）传输的。
- 心跳口必须是状态独立且具有IP地址的接口（物理口或Eth-Trunk口）
- 负责HRP心跳报文，HRP数据报文，HRP一致性检查报文和VGMP报文的传输。

心跳接口有五种状态：

| invalid  | 未指定心跳口的IP地址或心跳口功能在二层。     |
| -------- | -------------------------------------------- |
| peerdown | 本端正常，但是收不到对端的心跳探测报文。     |
| down     | 心跳接口的物理状态与协议状态均为Down.        |
| ready    | 正常运行。此接口为备用备份通道，当前未使用。 |
| running  | 正常运行。                                   |

HRP数据备份范围

- 通过HRP备份的数据包括主用设备的关键配置命令和状态信息。
- 能够备份配置命令，只能在主用设备上配置，备用设备不能配置。

可以备份的主用设备状态：

| 会话表            | NO-PAT方式地址映射表              |
| ----------------- | --------------------------------- |
| ServerMap表       | 二层转发表（静态MAC备份）         |
| 黑名单            | AAA用户表（缺省用户admin 不备份） |
| 白名单            | PKI证书，CRL                      |
| PAT方式端口映射表 | IPSec备份                         |

HRP数据备份方式

| 备份方式 | 备份命令                                                     | 备份状态信息                                                 | 配置命令      |
| -------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------- |
| 自动备份 | 在主用设备上每执行一条可以备份的命令时，此配置命令就会被同步执行到备用设备 | 当主设备上产生看需要备份的状态信息时，主用设备自动将状态信息同步到备用设备进行被封，备用设备更新状态。 | hrp auto-sync |

双机热备配置：

| vrrp vrid 1 virtual-ip 1.1.1.1 255.255.255.0 active | 配置VRRP     |
| --------------------------------------------------- | ------------ |
| hrp interface gi 1/0/7 remote 10.10.0.2             | 指定心跳接口 |
| PS：两端的心跳接口类型，编号，安全区域必须一致      |              |
| hrp enable                                          | 开启双机热备 |
| display hrp state                                   | 验证HRP状态  |

HRP主备管理建立成功后，命令上上有HRP_M的标识，表示主用设备；命令上有HRP_S的标识，表示备用设备。

### 智能选路

四种智能选路方式

- 根据链路带宽负载分担
- 根据链路权重负载分担
- 根据链路优先级主备备份
- 根据链路质量负载分担

根据链路带宽负载分担：

- 当企业从不同ISP处获得多条带宽不等的链路时，为了充分利用各链路的带宽，提高链路的利用率，可以选择此种选路方式
- 为了保证链路不会过载，管理员可以设置过载保护阈值。当某条链路的带宽使用率达到过载保护阈值时，已建立会话的流量从该链路转发，但是后续新建立会话的流量不在通过此链路转发

根据链路质量负载分担：

- 当企业从不同ISP处获得多条链路时，为了使用用户获得最佳的访问体验，能够根据各链路的实时传输质量动态调整流量的分配，可以选择此种方式。
- 衡量链路质量的3个参数：丢包率，时延和时延抖动。管理员可以根据实际需要选择其中的一个或多个参数。三个质量参数中，丢包率时最重要的参数，如果两条链路的丢包率，时延，时延抖动各不相同，那么判定丢包率小的链路质量高。
- 通过探测报文和回应报文来计算各个质量参数的值，由评估此ISP链路的质量，并将结果记录在链路质量探测表中。

根据链路权重负载分担：

- 当企业从不同ISP处获得多条性能不等的链路时，为了优先使用转发性能最优的链路，保证大多数用户的访问体验，且不浪费其他性能稍差的链路，可以选择此种选路方式。
- 管理员在各个接口指定权重时，一般来说，需要综合考虑各链路的带宽，转发时延，链路租界费用等因素，所谓的“转发性能最优的链路”并不单指转发速度最快的链路，而是最符合企业利益的链路，所以需要根据情况设置合理的权重。

根据链路优先级主备备份：

- 当企业从不同ISP处获得多条链路时，如果各链路的带宽，转发时延，链路租借费用等因素存在较大差异，希望优先使用某些链路传输流量，并利用其他链路作为备份链路或负载分担链路，提高业务的可靠性，此时可以选择本选路方式。
- 管理员为个接口指定合理的优先级后，优先级最高的接口称为主接口，其他优先级的接口统称为备份接口，优先使用主接口转发流量。
- 如果没有为主接口链路发生故障后，优先级次高的备份接口才被启用以替代主接口，而其他优先级更低的备份接口则仍未启用。这种情况可以称为主备备份场景。

会话保持：

- 过载保护阈值会导致链路切换，在某些情况下，可能会导致用户上网流量在接口链路
- 开启该功能后，流量进行首次智能选路选择某接口链路后，生成相应的会话保持表现，新流量如果命中了该会话保持表项，按照会话表项中记录的出接口转发流量，这样能保证该用户的流量始终使用同一接口链路转发。

### ISP选路

isp选路功能：也称为运营商地址库选路功能，可以使访问特定ISP网络的流量从相应出接口转发出去，保证流量转发最短路径。

- 配置ISP选路功能前，管理员需要把每个ISP网络内的IP地址分别写入不同的CSV文件
- 指定出接口与某个运营商名称关联后，防火墙会批量生成运营商网络ISP路由，在路由表中显示的协议类型为UNR,路由有衔接为70，低于静态路由的优先级（60）.

### 健康检查

### BFD

双向转发检测BFD提供了一个通用的标准化的介质无关的快速故障检测机制。

- 一种全网统一，检测迅速，监控网络中链路或者IP路由的双向转发联通状况，并为上层应用提供服务的技术。
- BFD以邻居会话形式检测并通知相应层的协议模块

BFD会话建立过程

DOWN

INIT

UP

联动功能介绍

- 联动功能由检测模块，track和应用模块三部分组成。

# 用户管理及认证技术

本地认证

服务器认证

单点登录

用户认证的目的

- 基于用户实现精细化管理
  1. 基于用户及进行策略的可视化制定，提高策略的易用性。
  2. 基于用户进行威胁，流量的报表查看和统计分析，实现对用户网络访问行为的追踪审计。
  3. 解决了IP地址动态变化带来的策略控制问题，即以不变的用户应对变化的IP地址。

认证域

新用户处理方式

- NGFW根据新用户选项来决定对新用户的处理方式，包括：
  1. 不允许新用户登录
  2. 添加到指定的用户组中
  3. 仅作为临时用户，不添加到本地用户列表中

认证策略

- 认证策略的作用时选出需要进行免认证或会话认证的数据流
  1. 对免认证的数据流，防火墙根据用户与IP/MAC地址的绑定关系来识别用户
  2. 对会话认证的数据流，防火墙会推送认证界面
  3. 认证策略对单点登录或事前认证方式不起作用
- 认证策略的条件：
  1. 源安全区域，目的安全区域
  2. 源地址/地区，目的地址/地区
- 认证策略的动作：认证，不认证

本地认证配置流程

配置认证域---创建用户/用户组----安全组--配置认证选项

认证协议-----Radius----远程用户拨号认证系统----AAA认证---UPD--1812--1813

HWTACACS

- TACACS（终端访问控制器访问控制系统）由RFC1492定义，默认使用port 49端口，早期用于Unix网络中的认证协议，各厂商做了一些扩展和定义。
- HWTACACS（Huawei Terminal Access Controller Access Control System）协议是华为TACACS进行了扩展的协议
- HWTACACS是在TACACS（RFC1492）基础上进行了功能增强的一种安全协议，该协议与RADIUS协议类似，主要是通过“客户端-服务器”模式与HWTACACS服务器通信来实现多种用户的AAA功能。

| HWTACACS                                           | RADIUS                             |
| -------------------------------------------------- | ---------------------------------- |
| 使用TCP协议，网络传输更可靠                        | 使用UDP协议                        |
| 除了标准的HWTACACS报文头，对报文主题全部及进行加密 | 只是对认证报文中的密码字段进行加密 |
| 认证与授权分离                                     | 认证与授权一起处理                 |
| 适于进行安全控制                                   | 适于进行计费                       |
| 支持对配置命令进行授权                             | 不支持对配置命令进行授权           |

SecurID

- RSA强认证系统就是依赖相同时间+相。却极为有效的方式来实现身份认证的。
- 令牌与认证服务器之间不需要任何通信联系，其核心就在于RSA的时间同步专利技术

LDAP

- LDAP是轻量级目录访问协议的简称，是一种基于TCP/IP的访问在线目录服务的协议。LDAP协议的典型应用是用来保存系统的用户信息，用于用户登录时的认证和授权。LDAP的目录服务功能建立在CLient/Server的基础之上，所有的目录信息存储在LDAP服务器上。
- 目录时一组具有类型属性，以一定逻辑和层次组合的信息。LDAP协议中目录时按照树形结构组织，目录由条目组成，条目时具有区别名的属性的集合

认证协议----AD

- AD（ActiveDirectories）是Windows Server域环境中提供目录服务的组件，可以将活动目录理解为目录服务在微软平台的一种实现方式。
- 活动目录将登陆身份验证以及目录对象的访问控制集成在一起，管理员可以管理分散在网络各处的目录数据和组织单位，经过授权的网络用户可以访问网络任意位置的资源

































































































































































































































































































































































































